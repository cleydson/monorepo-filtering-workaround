name: CodeQL Analysis and Upload of the SARIF results
description: >-
  Run CodeQL analysis, and upload the results to GitHub from the custom SARIF file.

inputs:
  WORKING_DIRECTORY:
    required: true
    type: string
    description: "Working directory of the project"
  SCRIPTING_LANGUAGES:
    required: true
    type: string
    description: "Scripting languages used in the project"
  TAG_NAME:
    required: true
    type: string
    description: "Tag name of the project"

runs:
  using: composite
  steps:

    - name: Perform CodeQL Analysis on ${{ inputs.WORKING_DIRECTORY }}
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{ inputs.SCRIPTING_LANGUAGES }}"
        upload: False
        output: sarif-results
      env:
      # https://codeql.github.com/docs/codeql-cli/manual/database-analyze/#options
      # add code snippet, query help and group rules by pack, to the SARIF file
        CODEQL_ACTION_EXTRA_OPTIONS: '{"database":{"analyze":["--sarif-add-snippets","--sarif-add-query-help","--sarif-group-rules-by-pack"]}}'

    # Rename CodeQL tool to allow filtering by workflow in Code Scanning
    - name: Rename CodeQL tool before uploading
      shell: bash
      run: |
        jq ".runs[0].tool.driver.name = \"CodeQL-${WORKFLOW_TAG}-${{ inputs.SCRIPTING_LANGUAGES }}\"" sarif-results/${{ inputs.SCRIPTING_LANGUAGES }}.sarif > sarif-results/${{ inputs.SCRIPTING_LANGUAGES }}-edited.sarif
      env:
        # edit this tag to something unique to your workflow
        WORKFLOW_TAG: ${{ inputs.TAG_NAME }}

    # Upload the CodeQL Analysis results
    - name: Upload SARIF
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: sarif-results/${{ inputs.SCRIPTING_LANGUAGES }}-edited.sarif
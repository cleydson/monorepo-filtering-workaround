name: "CodeQL - Project 2 and 3"
on:
  push:
    branches: [ "main" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:

  file_changes:
    name: file_changes
    outputs:
      build_path: "${{env.PROJECT_PATH}}"
      run_next_step: ${{ needs.file_changes.outputs.build_path }} != ''
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          project2:
          - project2/**
          project3:
          - project3/**
        token: "${{ github.token }}"

    - if: steps.changes.outputs.project2 == 'true'
      run: |
        echo "PROJECT_PATH=project2" >> $GITHUB_ENV
    - if: steps.changes.outputs.project3 == 'true'
      run: |
        echo "PROJECT_PATH=project3" >> $GITHUB_ENV
    - name: Echo PROJECT_PATH
      run: |
        echo "PROJECT_PATH=${{env.PROJECT_PATH}}"

  call_codeql_analysis:
    if: ${{ needs.file_changes.outputs.run_next_step }} 
    uses: ./.github/workflows/_codeql.yml
    # We can also use the following syntax for a different repository:
    #uses: cleydson/monorepo-filtering-workaround/.github/workflows/_codeql.yml@main
    with:
      WORKING_DIRECTORY: ${{ needs.file_changes.outputs.build_path }}
      SCRIPTING_LANGUAGES: 'java'
      TAG_NAME: ${{ needs.file_changes.outputs.build_path }}
    needs:
      - file_changes

    permissions:
      actions: read
      contents: read
      security-events: write
